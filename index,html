<!DOCTYPE html>
<html lang="en"> 
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Princess Malak's Spelling Castle üè∞</title>
    <style>
        :root {
            --primary: #ff69b4; /* Hot Pink */
            --accent: #9b59b6;  /* Purple */
            --bg-color: #fff0f5; /* Lavender Blush */
            --card-bg: #ffffff;
            --text: #555;
            --success: #2ecc71;
            --error: #ff4757;
            --hint: #f1c40f;    
            --font-main: 'Comic Sans MS', 'Chalkboard SE', 'Segoe UI', sans-serif;
        }

        body {
            font-family: var(--font-main);
            background-color: var(--bg-color);
            background-image: radial-gradient(#ffb6c1 20%, transparent 20%),
                              radial-gradient(#dda0dd 20%, transparent 20%);
            background-size: 30px 30px;
            background-position: 0 0, 15px 15px;
            color: var(--text);
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            margin: 0;
            padding: 10px;
            box-sizing: border-box;
        }

        .container {
            background: var(--card-bg);
            padding: 2rem;
            border-radius: 30px;
            box-shadow: 0 10px 25px rgba(255, 105, 180, 0.4);
            width: 100%;
            max-width: 500px;
            text-align: center;
            border: 6px solid white;
            position: relative;
            overflow-y: auto;
            max-height: 90vh;
        }

        h1 { 
            color: var(--primary); 
            margin-bottom: 0.5rem; 
            font-size: 2rem;
            text-shadow: 2px 2px 0px #ffe4e1;
            line-height: 1.2;
        }
        
        .crown { font-size: 3rem; display: block; margin-bottom: -10px; }

        /* VISUAL PROGRESS CIRCLES */
        .progress-grid {
            display: flex;
            flex-wrap: wrap;
            gap: 6px;
            justify-content: center;
            margin: 20px 0;
            min-height: 20px;
        }
        
        .prog-circle {
            width: 15px;
            height: 15px;
            background-color: #eee;
            border-radius: 50%;
            transition: transform 0.3s, background-color 0.3s;
            border: 2px solid white;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        
        .prog-circle.active { 
            background-color: #ffeb3b; 
            transform: scale(1.5); 
            border-color: var(--accent);
        }
        .prog-circle.correct { background-color: var(--success); }
        .prog-circle.wrong { background-color: var(--error); }

        input[type="text"] {
            width: 100%;
            max-width: 300px;
            padding: 15px;
            font-size: 1.5rem;
            margin: 20px auto;
            border: 4px solid #ffb6c1;
            border-radius: 20px;
            text-align: center;
            outline: none;
            color: var(--accent);
            font-family: var(--font-main);
            background: #fffafa;
            transition: all 0.3s;
            display: block;
            box-sizing: border-box;
        }
        
        input[type="text"]:focus { 
            border-color: var(--primary); 
            background-color: #fff; 
            box-shadow: 0 0 15px rgba(255,105,180, 0.3);
            transform: scale(1.02);
        }

        /* BUTTONS */
        .btn {
            background: linear-gradient(to bottom, #ff85c0, #ff69b4);
            color: white;
            border: none;
            padding: 15px 20px;
            font-size: 1.3rem;
            border-radius: 50px;
            cursor: pointer;
            transition: transform 0.2s, box-shadow 0.2s;
            margin-top: 15px;
            font-family: var(--font-main);
            font-weight: bold;
            box-shadow: 0 5px 0 #d63384;
            width: 100%;
            max-width: 280px;
            white-space: nowrap; 
        }
        .btn:hover { transform: translateY(-3px); box-shadow: 0 8px 0 #d63384; }
        .btn:active { transform: translateY(2px); box-shadow: 0 0 0 #d63384; }
        
        /* Different Button Colors */
        .btn-game { background: linear-gradient(to bottom, #ff85c0, #ff69b4); }
        .btn-practice { background: linear-gradient(to bottom, #a29bfe, #6c5ce7); box-shadow: 0 5px 0 #4834d4; }
        .btn-practice:hover { box-shadow: 0 8px 0 #4834d4; }
        
        .btn-retry {
            background: linear-gradient(to bottom, #ff6b6b, #ee5253);
            box-shadow: 0 5px 0 #c0392b;
        }

        /* CONTROL BUTTONS GROUP */
        .controls {
            display: flex;
            justify-content: center;
            gap: 20px;
            margin: 10px 0;
            align-items: center;
        }

        .btn-round {
            width: 70px;
            height: 70px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 2rem;
            cursor: pointer;
            border: none;
            color: white;
            transition: transform 0.2s;
        }
        .btn-round:hover { transform: scale(1.1); }
        .btn-round:active { transform: scale(0.95); }

        .btn-listen {
            background: linear-gradient(to bottom, #a29bfe, #6c5ce7);
            box-shadow: 0 4px 0 #4834d4;
        }
        
        .btn-hint {
            background: linear-gradient(to bottom, #f1c40f, #f39c12);
            box-shadow: 0 4px 0 #d35400;
            font-size: 1.8rem;
        }

        select {
            padding: 12px;
            font-size: 1.1rem;
            border-radius: 15px;
            border: 3px solid #ffb6c1;
            margin: 10px 0 20px 0;
            width: 100%;
            max-width: 300px;
            font-family: var(--font-main);
            color: var(--accent);
            cursor: pointer;
            background: white;
        }

        #feedback-area {
            min-height: 40px; 
            margin: 10px 0;
            font-size: 1.4rem;
            font-weight: bold;
            color: var(--primary);
        }
        
        #mode-indicator {
            background: var(--accent);
            color: white;
            padding: 5px 15px;
            border-radius: 20px;
            font-size: 0.9rem;
            display: inline-block;
            margin-bottom: 10px;
        }
        
        /* PRACTICE MODE TARGET WORD */
        #target-word-display {
            font-size: 3rem;
            color: var(--primary);
            font-weight: bold;
            margin: 10px 0;
            text-shadow: 2px 2px 0 #eee;
        }

        .hidden { display: none !important; }
        
        .result-list {
            list-style: none;
            padding: 0;
            text-align: left;
            margin-top: 20px;
            max-height: 200px;
            overflow-y: auto;
            border: 2px dashed #ffb6c1;
            border-radius: 15px;
            background: #fffcfc;
        }
        .result-item { padding: 10px; border-bottom: 1px dashed #eee; display: flex; justify-content: space-between; }
        
        @keyframes pop { 0% { transform: scale(1); } 50% { transform: scale(1.2); } 100% { transform: scale(1); } }
        .pop { animation: pop 0.3s ease; }
        
        @keyframes shake { 0% { transform: translateX(0); } 25% { transform: translateX(-5px); } 75% { transform: translateX(5px); } 100% { transform: translateX(0); } }
        .shake { animation: shake 0.3s ease; }

    </style>
</head>
<body>

<div class="container">
    <div id="start-screen">
        <span class="crown">üëë</span>
        <h1>Princess Malak's<br>Spelling Castle</h1>
        <p>Are you ready to be a star? üåü</p>
        
        <label style="color:var(--accent); font-weight:bold; display:block; margin-top:15px;">Choose a Level:</label>
        <select id="grade-select">
            <option value="2">üå∏ Grade 2 (Malak's Level)</option>
            <option value="3">ü¶Ñ Grade 3 (Challenge)</option>
            <option value="4">ü¶ã Grade 4 (Super Star)</option>
        </select>
        
        <label style="color:var(--accent); font-weight:bold; display:block; margin-top:15px;">How many words?</label>
        <select id="count-select">
            <option value="10">10 Words (Quick Fun) ‚ö°</option>
            <option value="15" selected>15 Words (Normal) üå∏</option>
            <option value="25">25 Words (Super Star) üåü</option>
            <option value="50">50 Words (The Queen) üëë</option>
        </select>
        <br>
        
        <div style="display:flex; flex-direction:column; gap:10px; align-items:center;">
            <button class="btn btn-practice" type="button" onclick="tryStartGame('practice')">üìù Practice Mode (Learn)</button>
            <button class="btn btn-game" type="button" onclick="tryStartGame('test')">üéÆ Game Mode (Test)</button>
        </div>
    </div>

    <div id="game-screen" class="hidden">
        <div id="mode-label" class="hidden">
            <span id="mode-indicator">ü¶Ñ Practice Mode</span>
        </div>

        <div style="display:flex; justify-content:space-between; color: var(--accent); font-weight:bold; font-size:1.1rem;">
            <span>Word <span id="current-count">1</span></span>
            <span>‚ú® Score: <span id="score-display">0</span></span>
        </div>
        
        <div id="progress-grid" class="progress-grid"></div>
        
        <div id="target-word-display" class="hidden">WORD</div>
        
        <div id="feedback-area"></div>

        <div class="controls">
            <button class="btn-round btn-listen" onclick="speakCurrentWord()" title="Listen to Word">üîä</button>
            <button class="btn-round btn-hint" id="hint-btn" onclick="fetchAndSpeakDefinition()" title="Get a Hint">üìñ</button>
        </div>
        
        <p id="help-text" style="margin-top:5px; font-size:0.9rem; color:#aaa;">Click speaker to listen ‚Ä¢ Click book for a hint</p>

        <input type="text" id="user-input" placeholder="Type here..." autocomplete="off">
        <br>
        <button class="btn" onclick="submitWord()">Check My Answer ‚ú®</button>
    </div>

    <div id="result-screen" class="hidden">
        <span class="crown">üéâ</span>
        <h1 style="font-size: 2.5rem;">All Done!</h1>
        
        <div style="font-size: 1.5rem; margin-bottom: 20px; color: var(--accent);">
            Malak got <strong id="final-score" style="color:var(--primary); font-size:2rem;">0</strong> words correct!
        </div>
        
        <div id="perfect-message" class="hidden" style="color: var(--success); font-size: 1.3rem; margin-bottom: 20px; font-weight:bold;">
            üåü PERFECT SCORE! You are a Queen! üåü
        </div>
        
        <div id="mistake-area" class="hidden">
            <button class="btn btn-retry" onclick="startDrillMode()">ü¶Ñ Practice Tricky Words</button>
            
            <p style="margin-top:20px;">Words to learn:</p>
            <ul id="mistake-list" class="result-list"></ul>
        </div>
        
        <button class="btn" onclick="resetGame()" style="margin-top:20px; background-color:#aaa; box-shadow:none;">Main Menu</button>
    </div>
</div>

<script>
    // --- DATABASE ---
    //
    const WORD_DATA = [
        {w:"pole",g:2},{w:"snake",g:2},{w:"mound",g:2},{w:"smaller",g:2},{w:"grand",g:2},
        {w:"gross",g:2},{w:"wish",g:2},{w:"stove",g:2},{w:"join",g:2},{w:"state",g:2},
        {w:"enter",g:2},{w:"blank",g:2},{w:"give",g:2},{w:"other",g:2},{w:"bedroom",g:2},
        {w:"branch",g:2},{w:"letter",g:2},{w:"spring",g:2},{w:"dance",g:2},{w:"front",g:2},
        {w:"roast",g:2},{w:"brave",g:2},{w:"bright",g:2},{w:"scream",g:2},{w:"river",g:2},
        {w:"bride",g:2},{w:"stall",g:2},{w:"point",g:2},{w:"wedding",g:2},{w:"little",g:2},
        {w:"doctor",g:2},{w:"peel",g:2},{w:"snack",g:2},{w:"notebook",g:2},{w:"brain",g:2},
        {w:"pride",g:2},{w:"dear",g:2},{w:"live",g:2},{w:"tubes",g:2},{w:"cloth",g:2},
        {w:"gazed",g:2},{w:"mile",g:2},{w:"float",g:2},{w:"snail",g:2},{w:"second",g:2},
        {w:"drew",g:2},{w:"stood",g:2},{w:"nagged",g:2},{w:"scan",g:2},{w:"glue",g:2},
        {w:"ground",g:3},{w:"shower",g:3},{w:"endless",g:3},{w:"plunger",g:3},{w:"fireworks",g:3},
        {w:"dazzle",g:3},{w:"climb",g:3},{w:"April",g:3},{w:"subway",g:3},{w:"broken",g:3},
        {w:"stew",g:3},{w:"shall",g:3},{w:"flowers",g:3},{w:"angry",g:3},{w:"create",g:3},
        {w:"drooped",g:3},{w:"cluttered",g:3},{w:"bursting",g:3},{w:"edge",g:3},{w:"glasses",g:3},
        {w:"gently",g:3},{w:"crowns",g:3},{w:"shutters",g:3},{w:"corner",g:3},{w:"barely",g:3},
        {w:"able",g:3},{w:"present",g:3},{w:"clearly",g:3},{w:"really",g:3},{w:"overcome",g:3},
        {w:"sketch",g:3},{w:"evening",g:3},{w:"again",g:3},{w:"finally",g:3},{w:"thumbs",g:3},
        {w:"glittery",g:3},{w:"together",g:3},{w:"while",g:3},{w:"mother",g:3},{w:"worth",g:3},
        {w:"solve",g:3},{w:"credit",g:3},{w:"steel",g:3},{w:"pour",g:3},{w:"anybody",g:3},
        {w:"whisper",g:3},{w:"Thursday",g:3},{w:"music",g:3},{w:"wears",g:3},{w:"thoughts",g:3},
        {w:"bronze",g:4},{w:"flea",g:4},{w:"buckeye",g:4},{w:"sudsy",g:4},{w:"antlers",g:4},
        {w:"dapper",g:4},{w:"stroll",g:4},{w:"cress",g:4},{w:"bestie",g:4},{w:"cereal",g:4},
        {w:"silence",g:4},{w:"fury",g:4},{w:"howdy",g:4},{w:"important",g:4},{w:"popovers",g:4},
        {w:"thousand",g:4},{w:"razor",g:4},{w:"roughly",g:4},{w:"drawl",g:4},{w:"oddity",g:4},
        {w:"insult",g:4},{w:"valley",g:4},{w:"gather",g:4},{w:"dessert",g:4},{w:"stagecoach",g:4},
        {w:"peaceful",g:4},{w:"ailment",g:4},{w:"combat",g:4},{w:"rotten",g:4},{w:"expressway",g:4},
        {w:"practice",g:4},{w:"squash",g:4},{w:"amused",g:4},{w:"pouch",g:4},{w:"outfits",g:4},
        {w:"sewing",g:4},{w:"transform",g:4},{w:"marble",g:4},{w:"gallon",g:4},{w:"flitting",g:4},
        {w:"plaza",g:4},{w:"yesterday",g:4},{w:"nighttime",g:4},{w:"putty",g:4},{w:"glumly",g:4},
        {w:"ignore",g:4},{w:"improve",g:4},{w:"internet",g:4},{w:"pantry",g:4},{w:"hungrily",g:4}
    ];

    const POSITIVE_WORDS = ["Wow Malak!", "Super Star!", "Great Job!", "Princess Power!", "Amazing!", "Perfect!", "So Smart!"];

    // --- SOUND ENGINE ---
    let audioCtx;
    let availableVoices = [];

    function initAudio() {
        if (!audioCtx) {
            audioCtx = new (window.AudioContext || window.webkitAudioContext)();
        }
        if (audioCtx.state === 'suspended') {
            audioCtx.resume();
        }
        
        availableVoices = window.speechSynthesis.getVoices();
        if (availableVoices.length === 0) {
            window.speechSynthesis.onvoiceschanged = () => {
                availableVoices = window.speechSynthesis.getVoices();
            };
        }
    }

    function getGentleFemaleVoice() {
        return availableVoices.find(v => v.name.includes("Samantha")) || 
               availableVoices.find(v => v.name.includes("Zira")) || 
               availableVoices.find(v => v.name.includes("Google US English")) ||
               availableVoices.find(v => v.name.includes("Female")) ||
               null;
    }

    function speak(text) {
        window.speechSynthesis.cancel();
        const u = new SpeechSynthesisUtterance(text);
        
        const voice = getGentleFemaleVoice();
        if (voice) {
            u.voice = voice;
        }

        u.lang = 'en-US';
        u.rate = 0.85; 
        u.pitch = 1.1; 
        
        window.speechSynthesis.speak(u);
    }

    function playDing() {
        if (!audioCtx) initAudio();
        const osc = audioCtx.createOscillator();
        const gain = audioCtx.createGain();
        osc.connect(gain);
        gain.connect(audioCtx.destination);
        osc.type = 'sine';
        osc.frequency.setValueAtTime(500, audioCtx.currentTime);
        osc.frequency.exponentialRampToValueAtTime(1000, audioCtx.currentTime + 0.1);
        gain.gain.setValueAtTime(0.3, audioCtx.currentTime);
        gain.gain.exponentialRampToValueAtTime(0.01, audioCtx.currentTime + 0.5);
        osc.start();
        osc.stop(audioCtx.currentTime + 0.5);
    }
    
    function playBuzz() {
        if (!audioCtx) initAudio();
        const osc = audioCtx.createOscillator();
        const gain = audioCtx.createGain();
        osc.connect(gain);
        gain.connect(audioCtx.destination);
        osc.type = 'sawtooth';
        osc.frequency.setValueAtTime(150, audioCtx.currentTime);
        osc.frequency.linearRampToValueAtTime(100, audioCtx.currentTime + 0.3);
        gain.gain.setValueAtTime(0.2, audioCtx.currentTime);
        gain.gain.linearRampToValueAtTime(0.01, audioCtx.currentTime + 0.3);
        osc.start();
        osc.stop(audioCtx.currentTime + 0.3);
    }

    // --- GAME STATE ---
    let sessionWords = [];
    let currentIndex = 0;
    let wrongAnswers = [];
    let score = 0;
    let currentMode = 'test'; // 'test', 'practice', 'drill'
    let practiceReps = 0; // Counts 0 to 3 for practice mode

    function tryStartGame(mode) {
        try {
            startGame(mode);
        } catch (e) {
            alert("Oops! Something went wrong: " + e.message);
        }
    }

    function startGame(mode) {
        currentMode = mode;
        currentIndex = 0;
        score = 0;
        practiceReps = 0;
        wrongAnswers = []; 
        
        initAudio(); 
        
        document.getElementById('mode-label').classList.add('hidden');
        document.getElementById('target-word-display').classList.add('hidden');
        document.getElementById('hint-btn').classList.remove('hidden'); // Show hint button by default
        
        // 1. SETUP WORD POOL
        if (mode === 'drill') {
            // Drill mode logic (re-practice mistakes)
             document.getElementById('mode-label').classList.remove('hidden');
             document.getElementById('mode-indicator').innerText = "ü¶Ñ Drill Mode (3x)";
             // Use existing drill logic (already shuffled externally or we do it here)
             // We assume 'sessionWords' is already populated for drill before calling this
             // But simpler: let's build drill pool here if passed 'drill'
             // Actually, simplest is to handle drill pool preparation before calling startGame
             // For now, let's assume sessionWords is set for drill.
        } else {
            // Normal Setup (Practice or Test)
            const gradeVal = document.getElementById('grade-select').value;
            const countVal = document.getElementById('count-select').value;
            const grade = parseInt(gradeVal);
            const limit = parseInt(countVal);
            
            let pool = WORD_DATA.filter(w => w.g === grade);
            if (pool.length === 0) return alert("No words found!");

            pool.sort(() => Math.random() - 0.5);
            sessionWords = pool.slice(0, limit);
            
            if (mode === 'practice') {
                 document.getElementById('mode-label').classList.remove('hidden');
                 document.getElementById('mode-indicator').innerText = "üìù Practice Mode";
                 document.getElementById('target-word-display').classList.remove('hidden');
                 document.getElementById('hint-btn').classList.add('hidden'); // No hint needed in practice
            }
        }
        
        // UI Reset
        document.getElementById('score-display').innerText = "0";
        document.getElementById('current-count').innerText = "1";
        document.getElementById('feedback-area').innerText = "";
        
        setupProgressGrid();
        switchScreen('game-screen');
        setTimeout(loadWord, 500);
    }
    
    // Helper to start drill mode from results screen
    function startDrillMode() {
        currentMode = 'drill';
        // Build drill pool
        let drillPool = [];
        wrongAnswers.forEach(item => {
             // 3x for drill
             drillPool.push(item); drillPool.push(item); drillPool.push(item);
        });
        drillPool.sort(() => Math.random() - 0.5);
        sessionWords = drillPool;
        
        currentIndex = 0;
        score = 0;
        practiceReps = 0;
        wrongAnswers = []; // Reset for new round
        
        initAudio();
        document.getElementById('mode-label').classList.remove('hidden');
        document.getElementById('mode-indicator').innerText = "ü¶Ñ Drill Mode (3x)";
        document.getElementById('target-word-display').classList.add('hidden');
        document.getElementById('hint-btn').classList.remove('hidden');
        
        document.getElementById('score-display').innerText = "0";
        document.getElementById('current-count').innerText = "1";
        document.getElementById('feedback-area').innerText = "";
        
        setupProgressGrid();
        switchScreen('game-screen');
        setTimeout(loadWord, 500);
    }

    function setupProgressGrid() {
        const grid = document.getElementById('progress-grid');
        grid.innerHTML = '';
        sessionWords.forEach((_, idx) => {
            const circle = document.createElement('div');
            circle.className = 'prog-circle';
            circle.id = 'circle-' + idx;
            grid.appendChild(circle);
        });
    }

    function updateProgress(index, status) {
        const circle = document.getElementById('circle-' + index);
        if (circle) {
            circle.classList.remove('active', 'correct', 'wrong');
            circle.classList.add(status);
        }
    }

    function loadWord() {
        document.getElementById('user-input').value = '';
        document.getElementById('user-input').focus();
        document.getElementById('current-count').innerText = currentIndex + 1;
        document.getElementById('feedback-area').innerText = "";
        updateProgress(currentIndex, 'active');
        
        // Practice Mode: Show Word
        if (currentMode === 'practice') {
             document.getElementById('target-word-display').innerText = sessionWords[currentIndex].w;
             document.getElementById('feedback-area').innerText = "Copy the word 3 times!";
             practiceReps = 0;
        } else {
             document.getElementById('target-word-display').innerText = "";
        }
        
        speakCurrentWord();
    }

    function speakCurrentWord() {
        speak(sessionWords[currentIndex].w);
    }

    async function fetchAndSpeakDefinition() {
        const word = sessionWords[currentIndex].w;
        const feedback = document.getElementById('feedback-area');
        feedback.innerText = "Thinking..."; 
        
        try {
            const response = await fetch(`https://api.dictionaryapi.dev/api/v2/entries/en/${word}`);
            if (!response.ok) throw new Error("No hint found");
            
            const data = await response.json();
            if(data && data[0] && data[0].meanings && data[0].meanings[0]) {
                const def = data[0].meanings[0].definitions[0].definition;
                feedback.innerText = "Here is a hint!";
                speak(def);
            } else {
                throw new Error("No definition");
            }
        } catch (e) {
            feedback.innerText = "No hint available üòî";
            speak("Sorry, I don't have a hint for this one.");
        }
    }

    function submitWord() {
        const input = document.getElementById('user-input').value.trim();
        const targetObj = sessionWords[currentIndex];
        const targetWord = targetObj.w;
        const feedback = document.getElementById('feedback-area');

        // CHECK ANSWER
        if (input.toLowerCase() === targetWord.toLowerCase()) {
            
            // --- LOGIC FOR PRACTICE MODE ---
            if (currentMode === 'practice') {
                practiceReps++;
                playDing();
                
                const inputEl = document.getElementById('user-input');
                inputEl.value = ''; // Clear input to force re-typing
                inputEl.focus();
                
                // Animation
                inputEl.classList.remove('shake');
                inputEl.classList.add('pop');
                setTimeout(() => inputEl.classList.remove('pop'), 300);

                if (practiceReps < 3) {
                    const remaining = 3 - practiceReps;
                    feedback.innerText = `Good! Write it ${remaining} more time${remaining > 1 ? 's' : ''}.`;
                    feedback.style.color = "var(--primary)";
                    return; // EXIT FUNCTION, WAIT FOR NEXT INPUT
                } else {
                    // Completed 3 reps
                    score++; // In practice mode, finishing a word counts as score
                    document.getElementById('score-display').innerText = score;
                    updateProgress(currentIndex, 'correct');
                    feedback.innerText = "Perfect! Next word!";
                    feedback.style.color = "var(--success)";
                }
            } 
            // --- LOGIC FOR TEST/DRILL MODE ---
            else {
                score++;
                document.getElementById('score-display').innerText = score;
                playDing();
                updateProgress(currentIndex, 'correct');
                
                const praise = POSITIVE_WORDS[Math.floor(Math.random() * POSITIVE_WORDS.length)];
                feedback.innerText = praise;
                feedback.style.color = "var(--success)";
                
                const inputEl = document.getElementById('user-input');
                inputEl.classList.remove('shake');
                inputEl.classList.add('pop');
                setTimeout(() => inputEl.classList.remove('pop'), 300);
            }

        } else {
            // WRONG ANSWER
            playBuzz();
            
            if (currentMode === 'practice') {
                feedback.innerText = "Oops! Look at the word and try again.";
            } else {
                feedback.innerText = "Oops! Not quite. Keep trying!";
                // Only track mistake in test/drill modes
                wrongAnswers.push({
                    w: targetWord,
                    g: targetObj.g,
                    attempt: input
                });
                updateProgress(currentIndex, 'wrong');
            }
            
            feedback.style.color = "var(--error)";
            const inputEl = document.getElementById('user-input');
            inputEl.classList.add('shake');
            setTimeout(() => inputEl.classList.remove('shake'), 300);
            
            // In test/drill mode, wrong answer moves to next word immediately
            if (currentMode !== 'practice') {
                // proceed to next word logic below
            } else {
                return; // In practice mode, stay on word until correct
            }
        }

        // MOVE TO NEXT WORD
        currentIndex++;

        if (currentIndex < sessionWords.length) {
            setTimeout(loadWord, 1500);
        } else {
            setTimeout(showResults, 1500);
        }
    }

    function showResults() {
        document.getElementById('final-score').innerText = score + " / " + sessionWords.length;
        
        const list = document.getElementById('mistake-list');
        list.innerHTML = '';
        const perfectMsg = document.getElementById('perfect-message');
        const mistakeArea = document.getElementById('mistake-area');

        // In Practice Mode, score is always perfect if they finished, so hide mistakes
        if (currentMode === 'practice') {
            perfectMsg.classList.remove('hidden');
            perfectMsg.innerText = "üåü Great Practice Session! üåü";
            mistakeArea.classList.add('hidden');
            playDing(); playDing();
            switchScreen('result-screen');
            return;
        }

        if (wrongAnswers.length === 0) {
            perfectMsg.classList.remove('hidden');
            perfectMsg.innerText = "üåü PERFECT SCORE! You are a Queen! üåü";
            mistakeArea.classList.add('hidden');
            playDing(); playDing();
        } else {
            perfectMsg.classList.add('hidden');
            mistakeArea.classList.remove('hidden');
            
            const uniqueMap = new Map();
            wrongAnswers.forEach(item => {
                if(!uniqueMap.has(item.w)) {
                    uniqueMap.set(item.w, item);
                }
            });
            const uniqueMistakes = [...uniqueMap.values()];
            
            uniqueMistakes.forEach(err => {
                const li = document.createElement('li');
                li.className = 'result-item';
                li.innerHTML = `
                    <span style="color:#aaa; text-decoration:line-through">${err.attempt || "..."}</span>
                    <span style="color:var(--primary); font-weight:bold;">${err.w}</span>
                `;
                list.appendChild(li);
            });
        }

        switchScreen('result-screen');
    }

    function resetGame() {
        switchScreen('start-screen');
    }

    function switchScreen(id) {
        document.getElementById('start-screen').classList.add('hidden');
        document.getElementById('game-screen').classList.add('hidden');
        document.getElementById('result-screen').classList.add('hidden');
        document.getElementById(id).classList.remove('hidden');
    }

    document.getElementById('user-input').addEventListener("keypress", function(event) {
        if (event.key === "Enter") submitWord();
    });

</script>

</body>
</html>
